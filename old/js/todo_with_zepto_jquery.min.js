var todo=function(e,t){return e=e||{},e.controller=e.controller||{},e.controller.createAndBindWidgetForTask=function(e,t){var n=t.newWidgetForTask(e.toDTO());return n.onToggleDoneRequest(function(t){e.done(t),e.save(function(e){n.done(e.done())})}),n},e.controller.AppController=function(t,n,r){r=r||e.controller.createAndBindWidgetForTask,this.start=function(e){t.forEach(function(e){r(e,n)},e),n.onNewTaskRequest(function(e){var i,s;i=t.newTask(e,function(){s.working(!1)}),s=r(i,n),s.working(!0)}),n.attachToDOM()}},e}(todo);var todo=function(e,t){return e=e||{},e.model=e.model||{},e.model.Tasks=function(t,n){var r=n||function(n){return new e.model.Task(n,t)},i=function(e){t.all(function(t){e(t.map(r))})};this.newTask=function(e,t){var n=r({description:e,done:!1});return n.save(function(e){t(e)}),n},this.forEach=function(e,t){i(function(n){var r=n.length;for(var i=0;i<r;i++)e(n[i]);typeof t=="function"&&t()})}},e.model.Task=function(e,t){var n=e.id,r=e.description,i=e.done;this.toDTO=function(){return{description:r,id:n,done:i}},this.done=function(e){return typeof e=="boolean"&&e!==i&&(i=!i),i},this.save=function(e){var r=this;t.save(r.toDTO(),function(t){n=t.id,e(r)})}},e}(todo);var todo=function(e,t){e=e||{},e.store=e.store||{};var n=function(){return"id"+Math.round(Math.random()*1e17)},r=function(e){return JSON.stringify(e)},i=function(e){return JSON.parse(e)},s=function(e,t){setTimeout(function(){t?e(t):e()},500)};return e.store.InMemoryStorage=function(){var e=[],t={},o=function(i,o){i.id=n(),t[i.id]=e.length,e.push(r(i)),s(o,i)};this.removeAll=function(e){s(e)},this.all=function(t){s(t,e.map(i))},this.save=function(n,i){var u=t[n.id];u?(e[u]=r(n),s(i,n)):o(n,i)}},e}(todo);Function.prototype.bind||(Function.prototype.bind=function(e){if(typeof this!="function")throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,r=function(){},i=function(){return n.apply(this instanceof r?this:e,t.concat(Array.prototype.slice.call(arguments)))};return r.prototype=this.prototype,i.prototype=new r,i});var todo=function(e,t){return e=e||{},e.utils=e.utils||{},e.utils.Event=function(){var e=[];this.subscribe=function(t){if(typeof t!="function")return;e.indexOf(t)===-1&&e.push(t)},this.publish=function(t){var n;e.forEach(function(e){try{e(t)}catch(n){console.log(n.toString(),n.stack)}})}},e.utils.field=function(t,n){var r=t,i=n||new e.utils.Event,s=function(e){if(typeof e!="undefined"){var t=r;return r=e,e!==t&&i.publish(r),s}return r};return s.subscribe=function(e){return i.subscribe(e),s},s},e}(todo);var todo=function(e,t){return e=e||{},e.widget=e.widget||{},e.widget.TaskWidget=function(t,n){var r=n||new e.utils.Event,i=function(){if(t.working())return;var e=!t.done();t.doneChk.checked(e),t.working(!0),r.publish(e)},s=function(){t.working(!1)},o=function(e){t.doneChk.enabled(!e)};this.done=t.done.bind(t),this.working=t.working.bind(t),this.onToggleDoneRequest=r.subscribe.bind(r),t.done.subscribe(s),t.working.subscribe(o),t.doneChk.checked.subscribe(i),t.onDescriptionClicked(i)},e.widget.CreateTaskWidget=function(t,n,r){var i=r||new e.utils.Event,s=function(e){n.enabled(!!e)},o=function(){var e=t.text();if(!e)return;t.text(""),i.publish(e)};this.onNewTaskRequest=i.subscribe.bind(i),this.focus=t.focus.bind(t),t.onKeyUp(function(e){e.keyCode===13&&o()}),t.text.subscribe(s),n.onClick(o),s(t.text())},e.widget.factory={newCreateTaskWidget:function(t,n){return new e.widget.CreateTaskWidget(t,n)},newTaskWidget:function(t){return new e.widget.TaskWidget(t)}},e.widget.AppWidget=function(t,n){var r=n||e.widget.factory,i=r.newCreateTaskWidget(t.newTaskDescription,t.addTaskBtn);this.newWidgetForTask=function(e){return r.newTaskWidget(t.newViewForTask(e))},this.onNewTaskRequest=i.onNewTaskRequest.bind(i),this.attachToDOM=function(){t.attachToDOM(),i.focus(!0)}},e}(todo);var todo=function(e,t,n){e=e||{},e.view=e.view||{},e.view.$=e.view.$||{};var r=function(t){return e.utils.field(t)};return e.view.$.TextFieldViewModel=function(t,n,i){var s=new e.utils.Event,o=function(e){e!==t.val()&&t.val(e)},u=function(e){e&&t.focus()},a=this.text=r(n).subscribe(o);this.onKeyUp=s.subscribe.bind(s),this.focus=r(i).subscribe(u),t.keyup(function(e){a(t.val()),s.publish(e)}),o(a()),u(this.focus())},e.view.$.ButtonViewModel=function(t,n){var i=new e.utils.Event,s=function(e){e?t.removeAttr("disabled"):t.attr("disabled",!0)};this.enabled=r(n).subscribe(s),this.onClick=i.subscribe.bind(i),t.click(i.publish.bind(i)),s(this.enabled())},e.view.$.CheckboxViewModel=function(e,t,n){n.removeAttr("checked");var i=function(e){e?n.removeAttr("disabled"):n.attr("disabled",!0)},s=function(e){n.prop("checked",e)};this.enabled=r(t).subscribe(i);var o=this.checked=r(e).subscribe(s);n.change(function(){o(n.prop("checked"))}),i(this.enabled()),s(o())},e.view.$.TaskViewModel=function(t,n){var i=new e.utils.Event,s=n.find(".txt"),o=function(e){n.toggleClass("done",e),n.toggleClass("todo",!e)},u=function(e){n.toggleClass("working",e)};this.done=r(t.done).subscribe(o),this.working=r(!1).subscribe(u),this.doneChk=new e.view.$.CheckboxViewModel(t.done,!1,n.find(".chk")),this.onDescriptionClicked=i.subscribe.bind(i),this.appendToDOM=function(e){e.append(n),n.show()},s.click(i.publish.bind(i)),s.text(t.description),o(this.done()),u(this.working())},e.view.$.TasksListViewModel=function(t){var n=!1,r=t.parent(),i=t.filter(".even").first(),s=t.filter(".odd").first(),o=[];this.activate=function(){o.forEach(function(e){e.appendToDOM(r)}),n=!0},this.newViewForTask=function(t){var u=o.length%2===0?i:s,a=new e.view.$.TaskViewModel(t,u.clone());return o.push(a),n&&a.appendToDOM(r),a},t.remove()},e.view.$.AppViewModel=function(t){this.newTaskDescription=new e.view.$.TextFieldViewModel(t.newTaskDescription,"",!1),this.addTaskBtn=new e.view.$.ButtonViewModel(t.addTaskBtn,!1);var n=new e.view.$.TasksListViewModel(t.tasksList,"");this.newViewForTask=n.newViewForTask.bind(n),this.attachToDOM=n.activate.bind(n)},e}(todo,window.Zepto||window.jQuery);$(function(){var e=new todo.store.InMemoryStorage,t=new todo.view.$.AppViewModel({tasksList:$(".task-list-widget .task-list .task"),newTaskDescription:$(".add-task-widget .txt"),addTaskBtn:$(".add-task-widget .btn")}),n=new todo.model.Tasks(e),r=new todo.widget.AppWidget(t),i=new todo.controller.AppController(n,r);window.underTest?(window.startApp=i.start.bind(i),window.testStorage=e):i.start()})